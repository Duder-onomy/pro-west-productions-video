#!/usr/bin/env bash
#set -x # for debugging

NODE_ENV="dev"
DEBUG=""
WAIT=10
DEBUG_WAIT=20

    while test $# -gt 0; do
        case "$1" in
            -h|--help)
                echo "Start the node server using nodemon"
                echo " "
                echo "The default environment is 'dev' if no flags are passed."
                echo " "
                echo "options:"
                echo "-h, --help        show help"
                echo "-d|--debug        start with --debug flag"
                echo "-r|--dev-remote   set NODE_ENV to dev-remote"
                echo "                      local code, staging data"
                exit 0
                ;;
            -d|--debug)
                shift
                WAIT="$DEBUG_WAIT"
                DEBUG="debug"
                ;;
            -r|--dev-remote)
                shift
                NODE_ENV="dev-remote"
                ;;
            *)
                break
                ;;
        esac
    done

if [ "dev-remote" = "$NODE_ENV" ]
then
    echo "openning ssh tunnel to remote data"
    echo "$WAIT seconds to connect mongo"
    echo "if you want nodemon to work open a new tab, vagrant ssh and run, './bin/keepAlive'"
    # https://gist.github.com/scy/6781836
    vagrant exec "ssh -f -o ExitOnForwardFailure=yes -L 27018:localhost:27017 ts@staging-ssh.cambiumnetworks.com sleep $WAIT"
fi

if [ -z "$DEBUG" ]
then
    vagrant exec "NODE_ENV=$NODE_ENV /home/vagrant/.npm-packages/bin/nodemon /home/vagrant/cambium/app"
else
    echo "opening ssh tunnel for debugging"
    echo " "
    echo "the passowrd is: vagrant"
    ssh -f -o ExitOnForwardFailure=yes -L 5858:127.0.0.1:5858 vagrant@192.168.99.99 sleep "$WAIT"
    echo " "
    echo "You have about 20 seconds to get your debug connections going"
    echo "      for webstorm set your Nodejs Remote Debug Host to 127.0.0.1 and Port 5858"
    echo " "
    vagrant exec "NODE_ENV=$NODE_ENV node --debug /home/vagrant/cambium/app"
fi
